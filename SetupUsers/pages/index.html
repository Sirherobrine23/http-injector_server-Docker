<!DOCTYPE html>
<html lang="en">
    <script src="/configJson.js"></script>
<script>
    if (typeof jsonConfig === "undefined"||jsonConfig === AudioNode) {
      var jsonConfig = {}/* Origin */;
    if (jsonConfig.openssh === undefined) {jsonConfig.openssh = {};jsonConfig.openssh.ports = []}
    if (jsonConfig.dropebear === undefined) {jsonConfig.dropebear = {};jsonConfig.dropebear.ports = []}
    if (jsonConfig.squid === undefined) {jsonConfig.squid = {};jsonConfig.squid.ports = []}
    if (jsonConfig.badvpn === undefined) jsonConfig.badvpn = {};jsonConfig.badvpn.port = 7300
    if (jsonConfig.users === undefined) jsonConfig.users = []
    }
    console.log(jsonConfig);
    const token = sessionStorage.getItem("token");
    if (token === null || token === undefined || token === "") location.replace(`/login/?error=token was not informed`)
    fetch("/check_token", {
        mode: "cors",
        method: "POST",
        headers: {
            token: token
        }
    }).then(function (response){
        globalThis.response = response
        if (!response.ok) location.replace("/login/?error=Token has expired or is wrong");
        return response;
    });
</script>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="Title">Home</title>
</head>
<style>
.conatainer_root {
    text-align: center;
    margin-top: 12vh;
}

</style>
<body>
    <div class="add_user conatainer_root">
        <h2>Add User</h2>
        <div onchange="PublishJson();" oninput="PublishJson();" onkeypress="PublishJson();">
            <span>Username: <input type="text" name="user" id="user" autocomplete="off" min="2" max="10"></span>
            <p><span>Passworld: <input type="password" name="pass" id="pass" minlength="2" maxlength="10"></span></p>
            <p><span>Expiration date: <input type="date" name="data" id="data"></span> <span id="diasrestantes">0</span></p>
            <p><span>Connections: <input type="number" name="connections" value="1" id="connections"></span></p>
            <p><input type="button" value="Save User" id="saveUserButtom" onclick="SaveUserinJson()"></p>
        </div>
        <textarea disabled id="outputJson" style="margin: 0px; width: 60vh; height: 10rem; resize: none;">{}</textarea>
        <script>
            function SaveUserinJson(){
                let UsernameConfig = JSON.parse(document.getElementById("outputJson").innerHTML)
                jsonConfig.users.push(UsernameConfig)
                document.getElementById("saveUserButtom").setAttribute("disabled", null);
                document.getElementById("pass").value = ""
                document.getElementById("data").value = ""
                document.getElementById("connections").value = 1
                document.getElementById("outputJson").innerHTML = JSON.stringify({})
                addRemoveUser(UsernameConfig.user)
            }
            function PublishJson(){
                for (let index of jsonConfig.users){
                    if (document.getElementById("user").value === index.user) return document.getElementById("saveUserButtom").setAttribute("disabled", null);
                    document.getElementById("saveUserButtom").removeAttribute("disabled")
                }
                let JsonFile = {}
                JsonFile.user = (document.getElementById("user").value||"usertest")
                JsonFile.pass = btoa((document.getElementById("pass").value||"teste12"))
                let data = (document.getElementById("data").value||`${new Date().getFullYear()}-${new Date().getMonth()}-${new Date().getDate()}`).split("-")
                JsonFile.data = `${data[2]}/${data[1]}/${data[0]}`
                document.getElementById("diasrestantes").innerHTML = "Days Remaining: "+restdate(JsonFile.data)
                JsonFile.ssh = (parseInt(document.getElementById("connections").value)||1)
                document.getElementById("outputJson").innerHTML = JSON.stringify(JsonFile, null, 2)
            }
            function restdate(d){
                const date1 = d.split("/")
                // date1[1] // Month
                // date1[0] // day
                // date1[2] // year
                const current_day = new Date().getDate()
                const current_month = new Date().getMonth()
                const current_year = new Date().getFullYear()

                const oneDay = 24 * 60 * 60 * 1000; // hours*minutes*seconds*milliseconds
                const firstDate = new Date(date1[2], date1[1] - 1, date1[0]);
                const secondDate = new Date(current_year, current_month, current_day);
                const result = ((firstDate - secondDate) / oneDay)
                if (result < 0) return 0
                else return Math.round(Math.abs(result));
            }
            function addRemoveUser(username){
                const numberRemove = jsonConfig.users.length - 1
                const divRemove = document.createElement("a")
                const divBase = document.createElement("div")
                const spanTex = document.createElement("span")
                
                spanTex.innerHTML = "&#8855;"

                divRemove.classList.add("userremove")
                divRemove.onclick = function () {
                    jsonConfig.users.pop(numberRemove);
                    divBase.remove();
                };
                divRemove.appendChild(spanTex)

                divBase.id = `Username_${numberRemove}`
                divBase.classList.add("usernameArea")
                divBase.innerHTML += `${jsonConfig.users.length}, ${username}: remove`
                divBase.appendChild(divRemove)

                document.getElementById("removeUser").appendChild(divBase)
            }
        </script>
    </div>

    <!-- Remove User -->
    <div class="add_user conatainer_root">
        <h2>Remove User</h2>
        <fieldset>
            <span>Num, Username: Action</span>
            <p><div id="removeUser"></div></p>
        </fieldset>
    </div>

    <!-- Settings User -->
    <div class="settings Server conatainer_root">
        <h2>Server Settings</h2>
        <div onchange="">
            <div> OpenSSH:
                <fieldset>
                    <p><span>port: <input type="number" id="portOpenSSH"></span><input type="button" onclick="opensshAdd()" value="Add"></p>
                    <div id="opensshportarea"></div>
                </fieldset>
                <script>
                    function opensshAdd(){
                        const port = parseInt(document.getElementById("portOpenSSH").value)
                        for (let index of jsonConfig.openssh.ports) if (parseInt(index) === port) return false;
                        for (let index of jsonConfig.dropebear.ports) if (parseInt(index) === port) return false;
                        for (let index of jsonConfig.squid.ports) if (parseInt(index) === port) return false;
                        jsonConfig.openssh.ports.push(port)
                        document.getElementById("portOpenSSH").value = ""
                        const divRemove = document.createElement("a")
                        const divBase = document.createElement("div")
                        const spanTex = document.createElement("span")
                        
                        spanTex.innerHTML = "&#8855;"

                        divRemove.classList.add("portremove")
                        divRemove.onclick = function () {
                            jsonConfig.openssh.ports.pop(port);
                            divBase.remove();
                        };
                        divRemove.appendChild(spanTex)

                        divBase.id = `Openssh_${port}`
                        divBase.classList.add("portarea")
                        divBase.innerHTML += `Port ${jsonConfig.openssh.ports.length}: ${port}`
                        divBase.appendChild(divRemove)

                        document.getElementById("opensshportarea").appendChild(divBase)
                        return true
                    }
                </script>
            </div>
            <br>
            <div> Dropbear:
                <fieldset>
                    <p><span>port: <input type="number" id="portdropbear"></span><input type="button" onclick="dropbearAdd()" value="Add"></p>
                    <div id="dropbearportarea"></div>
                    <script>
                        
                        function dropbearAdd(){
                            const port = parseInt(document.getElementById("portdropbear").value)
                            for (let index of jsonConfig.openssh.ports) if (parseInt(index) === port) return false;
                            for (let index of jsonConfig.dropebear.ports) if (parseInt(index) === port) return false;
                            for (let index of jsonConfig.squid.ports) if (parseInt(index) === port) return false;
                            jsonConfig.dropebear.ports.push(port)
                            document.getElementById("portdropbear").value = ""
                            const divRemove = document.createElement("a")
                            const divBase = document.createElement("div")
                            const spanTex = document.createElement("span")
                            
                            spanTex.innerHTML = "&#8855;"

                            divRemove.classList.add("portremove")
                            divRemove.onclick = function () {
                                jsonConfig.dropebear.ports.pop(port);
                                divBase.remove();
                            };
                            divRemove.appendChild(spanTex)

                            divBase.id = `dropbear_${port}`
                            divBase.classList.add("portarea")
                            divBase.innerHTML += `Port ${jsonConfig.dropebear.ports.length}: ${port}`
                            divBase.appendChild(divRemove)

                            document.getElementById("dropbearportarea").appendChild(divBase);
                            return true
                        }
                    </script>
                </fieldset>
            </div>
            <br>
            <div> Squid:
                <fieldset>
                    <p><span>port: <input type="number" id="portsquid"></span><input type="button" onclick="squidAdd()" value="Add"></p>
                    <div id="squidportarea"></div>
                    <script>
                        
                        function squidAdd(){
                            const port = parseInt(document.getElementById("portsquid").value)
                            for (let index of jsonConfig.openssh.ports) if (parseInt(index) === port) return false;
                            for (let index of jsonConfig.dropebear.ports) if (parseInt(index) === port) return false;
                            for (let index of jsonConfig.squid.ports) if (parseInt(index) === port) return false;
                            jsonConfig.squid.ports.push(port)
                            document.getElementById("portsquid").value = ""
                            const divRemove = document.createElement("a")
                            const divBase = document.createElement("div")
                            const spanTex = document.createElement("span")
                            
                            spanTex.innerHTML = "&#8855;"

                            divRemove.classList.add("portremove")
                            divRemove.onclick = function () {
                                jsonConfig.squid.ports.pop(port);
                                divBase.remove();
                            };
                            divRemove.appendChild(spanTex)

                            divBase.id = `squid_${port}`
                            divBase.classList.add("portarea")
                            divBase.innerHTML += `Port ${jsonConfig.squid.ports.length}: ${port}`
                            divBase.appendChild(divRemove)
                            document.getElementById("squidportarea").appendChild(divBase)
                            return true
                        }
                    </script>
                </fieldset>
            </div>
        </div>
        <p><span>Send Config to Save</span></p>
        <fieldset>
            <textarea id="ConfigJson" cols="30" rows="10" disabled style="margin: 0px; width: 102vh; height: 10rem; resize: none;"></textarea>
            <p><input type="button" value="Send Config" onclick="sendConfig();"></p>
        </fieldset>
        <script>
            function sendConfig() {
                if (jsonConfig.openssh.ports.length === 0) return alert("Set ports to OpenSSH")
                if (jsonConfig.dropebear.ports.length === 0) return alert("Set ports to Dropbear")
                if (jsonConfig.squid.ports.length === 0) return alert("Set ports to Squid")
                if (jsonConfig.users.length === 0) return alert("Set users.")
                fetch("/save_config", {
                    mode: "cors",
                    method: "POST",
                    headers: {
                        token: token,
                        injectorconfig: btoa(JSON.stringify(jsonConfig)).toString()
                    }
                })
            }
            setInterval(() => {
                document.getElementById("ConfigJson").innerHTML = JSON.stringify(jsonConfig, null, 4)
            }, 500);
        </script>
    </div>
</body>
</html>